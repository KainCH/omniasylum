@page "/dashboard"
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using OmniForge.Core.Entities
@using OmniForge.Core.Interfaces
@using OmniForge.Web.Components.Modals
@attribute [Authorize]
@inject ICounterRepository CounterRepository
@inject IOverlayNotifier OverlayNotifier
@inject NavigationManager NavigationManager
@inject IStreamMonitorService StreamMonitorService

<PageTitle>Dashboard</PageTitle>

<div class="stream-counter-container">
    <h1>Stream Counter</h1>

    <AuthorizeView>
        <Authorized>
            @if (counter == null)
            {
                <p><em>Loading counters...</em></p>
            }
            else
            {
                <div class="counters-grid">
                    <div class="counter-box deaths">
                        <div class="counter-label">Deaths</div>
                        <div class="counter-value">@counter.Deaths</div>
                        <button class="btn-increment" @onclick="() => UpdateCounter(c => c.Deaths++)">+</button>
                        <button class="btn-decrement" @onclick="() => UpdateCounter(c => c.Deaths--)">−</button>
                    </div>

                    <div class="counter-box swears">
                        <div class="counter-label">Swears</div>
                        <div class="counter-value">@counter.Swears</div>
                        <button class="btn-increment" @onclick="() => UpdateCounter(c => c.Swears++)">+</button>
                        <button class="btn-decrement" @onclick="() => UpdateCounter(c => c.Swears--)">−</button>
                    </div>
                </div>

                <div class="controls-section">
                    <button class="btn-custom @(isMonitoring ? "btn-danger" : "btn-success")" @onclick="ToggleMonitoring">
                        <i class="bi @(isMonitoring ? "bi-stop-circle-fill" : "bi-play-circle-fill")"></i> @(isMonitoring ? "Stop Monitor" : "Start Monitor")
                    </button>
                    <button class="btn-custom btn-reset" @onclick="ResetCounters">Reset All</button>
                    <button class="btn-custom btn-export" @onclick="ExportData">Export Data</button>
                    <button class="btn-custom btn-primary" @onclick="() => showOverlaySettings = true">
                        <i class="bi bi-gear-fill"></i> Settings
                    </button>
                    <button class="btn-custom btn-warning" @onclick="() => showAlertsManager = true" style="background-color: #fd7e14; color: white;">
                        <i class="bi bi-bell-fill"></i> Alerts
                    </button>
                    <button class="btn-custom btn-info" @onclick="() => showAlertEffects = true">
                        <i class="bi bi-magic"></i> Effects
                    </button>
                    <button class="btn-custom btn-discord" @onclick="() => showDiscordSettings = true" style="background-color: #5865F2; color: white;">
                        <i class="bi bi-discord"></i> Discord
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <span>Total Events:</span>
                        <span>@(counter.Deaths + counter.Swears)</span>
                    </div>
                    <div class="stat-item">
                        <span>Last Updated:</span>
                        <span>@(counter.LastUpdated.ToLocalTime().ToString("g"))</span>
                    </div>
                </div>

                <div class="mt-4 text-center">
                     <p>
                        <strong>Twitch User ID:</strong> @TwitchUserId <br />
                        <strong>Overlay URL:</strong> <a href="@OverlayUrl" target="_blank">@OverlayUrl</a>
                    </p>
                </div>

                <OverlaySettingsModal @bind-Show="showOverlaySettings" UserId="@TwitchUserId" OnSaved="OnSettingsSaved" />
                <AlertsManagerModal @bind-Show="showAlertsManager" UserId="@TwitchUserId" />
                <AlertEffectsModal @bind-Show="showAlertEffects" />
                <DiscordWebhookSettingsModal @bind-Show="showDiscordSettings" UserId="@TwitchUserId" />
            }
        </Authorized>
    </AuthorizeView>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? authenticationStateTask { get; set; }

    private OmniForge.Core.Entities.Counter? counter;
    private string? TwitchUserId;
    private string? OverlayUrl;
    private bool showOverlaySettings = false;
    private bool showAlertsManager = false;
    private bool showAlertEffects = false;
    private bool showDiscordSettings = false;
    private bool isMonitoring = false;

    protected override async Task OnInitializedAsync()
    {
        if (authenticationStateTask != null)
        {
            var authState = await authenticationStateTask;
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                // Twitch OAuth maps the ID to NameIdentifier by default
                TwitchUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

                if (!string.IsNullOrEmpty(TwitchUserId))
                {
                    counter = await CounterRepository.GetCountersAsync(TwitchUserId);
                    // Use the static HTML overlay instead of the Blazor page
                    OverlayUrl = NavigationManager.ToAbsoluteUri($"/overlay.html?userId={TwitchUserId}").ToString();
                    isMonitoring = StreamMonitorService.IsUserSubscribed(TwitchUserId);
                }
            }
        }
    }

    private async Task ToggleMonitoring()
    {
        if (string.IsNullOrEmpty(TwitchUserId)) return;

        if (isMonitoring)
        {
            await StreamMonitorService.UnsubscribeFromUserAsync(TwitchUserId);
            isMonitoring = false;
        }
        else
        {
            await StreamMonitorService.SubscribeToUserAsync(TwitchUserId);
            isMonitoring = true;
        }
    }

    private async Task UpdateCounter(Action<OmniForge.Core.Entities.Counter> updateAction)
    {
        if (counter != null && !string.IsNullOrEmpty(TwitchUserId))
        {
            updateAction(counter);
            counter.LastUpdated = DateTime.UtcNow;
            await CounterRepository.SaveCountersAsync(counter);
            await OverlayNotifier.NotifyCounterUpdateAsync(TwitchUserId, counter);
        }
    }

    private async Task ResetCounters()
    {
        if (counter != null && !string.IsNullOrEmpty(TwitchUserId))
        {
            counter.Deaths = 0;
            counter.Swears = 0;
            counter.LastUpdated = DateTime.UtcNow;
            await CounterRepository.SaveCountersAsync(counter);
            await OverlayNotifier.NotifyCounterUpdateAsync(TwitchUserId, counter);
        }
    }

    private void ExportData()
    {
        // TODO: Implement export functionality
    }

    private async Task OnSettingsSaved()
    {
        // Notify overlay of setting changes if needed
        if (!string.IsNullOrEmpty(TwitchUserId) && counter != null)
        {
            await OverlayNotifier.NotifyCounterUpdateAsync(TwitchUserId, counter);
        }
    }
}
