@page "/request-access"
@using System.ComponentModel.DataAnnotations
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Request Access - OmniForge</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-lg border-0 rounded-lg">
                <div class="card-header bg-primary text-white text-center py-4">
                    <h2 class="mb-0"><i class="bi bi-key-fill me-2"></i>Request Access</h2>
                    <p class="mb-0 mt-2 opacity-75">Join the OmniForge Streamer Community</p>
                </div>
                <div class="card-body p-5">
                    @if (submitted)
                    {
                        <div class="alert alert-success text-center" role="alert">
                            <h4 class="alert-heading"><i class="bi bi-check-circle-fill me-2"></i>Request Submitted!</h4>
                            <p>Thank you for your interest. We will review your request and contact you shortly.</p>
                            <hr>
                            <p class="mb-0">
                                <a href="/" class="btn btn-outline-success">Return Home</a>
                            </p>
                        </div>
                    }
                    else
                    {
                        <EditForm Model="@requestModel" OnValidSubmit="HandleValidSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger mb-3" />

                            <div class="form-floating mb-3">
                                <InputText id="username" class="form-control" @bind-Value="requestModel.Username" placeholder="Twitch Username" />
                                <label for="username">Twitch Username</label>
                                <ValidationMessage For="@(() => requestModel.Username)" />
                            </div>

                            <div class="form-floating mb-3">
                                <InputText id="email" class="form-control" @bind-Value="requestModel.Email" placeholder="Email Address" />
                                <label for="email">Email Address</label>
                                <ValidationMessage For="@(() => requestModel.Email)" />
                            </div>

                            <div class="form-floating mb-3">
                                <InputTextArea id="reason" class="form-control" @bind-Value="requestModel.Reason" placeholder="Why do you want to join?" style="height: 150px" />
                                <label for="reason">Why do you want to join?</label>
                                <ValidationMessage For="@(() => requestModel.Reason)" />
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary btn-lg" disabled="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Submitting...</span>
                                    }
                                    else
                                    {
                                        <span>Submit Request</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
                <div class="card-footer text-center py-3">
                    <small class="text-muted">Already have an account? <a href="/login">Login here</a></small>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private RequestAccessModel requestModel = new();
    private bool submitted = false;
    private bool isSubmitting = false;

    private async Task HandleValidSubmit()
    {
        isSubmitting = true;
        try
        {
            // In a real scenario, this would post to the API
            // var response = await Http.PostAsJsonAsync("api/request-access", requestModel);

            // For now, we'll simulate a successful submission since the backend endpoint might not be fully ready for direct calls from Blazor Server without auth
            // Or we can try to call it if we have the base address set up correctly.
            // Assuming the API is on the same domain or configured in Program.cs

            // Simulate delay
            await Task.Delay(1000);

            submitted = true;
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error submitting request: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class RequestAccessModel
    {
        [Required(ErrorMessage = "Twitch Username is required")]
        public string Username { get; set; } = "";

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid Email Address")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Please tell us why you want to join")]
        [MinLength(10, ErrorMessage = "Reason must be at least 10 characters")]
        public string Reason { get; set; } = "";
    }
}
