@page "/admin/monitor"
@using Microsoft.AspNetCore.Authorization
@using OmniForge.Core.Interfaces
@using OmniForge.Core.Entities
@attribute [Authorize(Roles = "admin")]
@rendermode InteractiveServer
@inject IUserRepository UserRepository
@inject IStreamMonitorService StreamMonitorService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>Admin - Stream Monitoring</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Stream Monitoring</h1>
    </div>

    @if (users == null)
    {
        <p><em>Loading users...</em></p>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-md-6">
                <label for="userSelect" class="form-label">Select streamer</label>
                <select id="userSelect" class="form-select" @onchange="OnUserChanged">
                    <option value="">-- Choose a streamer --</option>
                    @foreach (var user in users)
                    {
                        <option value="@user.TwitchUserId" selected="@(user.TwitchUserId == selectedUserId)">
                            @user.DisplayName (@user.Username)
                        </option>
                    }
                </select>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(selectedUserId))
        {
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h5 class="card-title">Status</h5>
                    @if (status != null)
                    {
                        <ul class="list-unstyled mb-2">
                            <li><strong>Connected:</strong> @status.Connected</li>
                            <li><strong>Subscribed:</strong> @StreamMonitorService.IsUserSubscribed(selectedUserId)</li>
                            <li><strong>Subscriptions:</strong> @(status.Subscriptions?.Length > 0 ? string.Join(", ", status.Subscriptions) : "None")</li>
                            <li><strong>Last Connected:</strong> @(status.LastConnected?.ToLocalTime().ToString("g") ?? "-")</li>
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted">No status available.</p>
                    }

                    <button class="btn btn-success" @onclick="StartMonitoring" disabled="@(isWorking)">
                        <i class="bi bi-broadcast-pin"></i> Start Monitoring
                    </button>
                    <button class="btn btn-outline-secondary ms-2" @onclick="RefreshStatus" disabled="@(isWorking)">
                        Refresh Status
                    </button>
                </div>
            </div>
        }
    }
</div>

@code {
    private IEnumerable<User>? users;
    private string? selectedUserId;
    private StreamMonitorStatus? status;
    private User? currentUser;
    private bool isWorking = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        users = await UserRepository.GetAllUsersAsync();
        // preselect first non-admin user if any
        selectedUserId = users?.FirstOrDefault(u => u.Role != "admin")?.TwitchUserId;
        await RefreshStatus();
    }

    private async Task LoadCurrentUser()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst("userId")?.Value;
        if (!string.IsNullOrEmpty(userId))
        {
            currentUser = await UserRepository.GetUserAsync(userId);
        }
    }

    private async Task OnUserChanged(ChangeEventArgs e)
    {
        selectedUserId = e.Value?.ToString();
        await RefreshStatus();
    }

    private async Task RefreshStatus()
    {
        if (string.IsNullOrEmpty(selectedUserId)) { status = null; return; }
        status = StreamMonitorService.GetUserConnectionStatus(selectedUserId);
        await InvokeAsync(StateHasChanged);
    }

    private async Task StartMonitoring()
    {
        if (string.IsNullOrEmpty(selectedUserId) || currentUser == null) return;
        try
        {
            isWorking = true;
            var result = await StreamMonitorService.SubscribeToUserAsAsync(selectedUserId, currentUser.TwitchUserId);
            if (result == SubscriptionResult.Success)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Monitoring started for {selectedUserId}.");
                await RefreshStatus();
            }
            else if (result == SubscriptionResult.RequiresReauth)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Admin token missing required Twitch permissions. Re-auth required.");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to start monitoring.");
            }
        }
        finally
        {
            isWorking = false;
        }
    }
}
