@page "/admin/counter-requests"
@using Microsoft.AspNetCore.Authorization
@using OmniForge.Core.Entities
@using OmniForge.Core.Interfaces
@attribute [Authorize(Roles = "admin")]
@rendermode InteractiveServer
@inject ICounterRequestRepository CounterRequestRepository
@inject ICounterLibraryRepository CounterLibraryRepository

<PageTitle>Admin - Counter Requests</PageTitle>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Counter Requests</h1>
    <button class="btn btn-outline-secondary" @onclick="Reload" disabled="@isBusy">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>

  @if (!string.IsNullOrWhiteSpace(successMessage))
  {
    <div class="alert alert-success alert-dismissible fade show">
      <i class="bi bi-check-circle me-2"></i>@successMessage
      <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
    </div>
  }

  @if (!string.IsNullOrWhiteSpace(errorMessage))
  {
    <div class="alert alert-danger alert-dismissible fade show">
      <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
      <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
  }

  @if (isLoading)
  {
    <div class="text-center p-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }
  else if (requests.Count == 0)
  {
    <div class="text-center text-muted p-5">
      <i class="bi bi-inbox fs-1 d-block mb-2"></i>
      No pending counter requests.
    </div>
  }
  else
  {
    <div class="list-group">
      @foreach (var req in requests)
      {
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">@req.Name</div>
              <div class="small text-muted">Requested by: @req.RequestedByUserId</div>
              @if (!string.IsNullOrWhiteSpace(req.Description))
              {
                <div class="small mt-2">@req.Description</div>
              }
              <div class="small text-muted mt-2">Icon: @req.Icon</div>
            </div>
            <div class="btn-group">
              <button class="btn btn-success btn-sm" @onclick="() => Approve(req)" disabled="@isBusy">
                <i class="bi bi-check-lg"></i> Approve
              </button>
              <button class="btn btn-danger btn-sm" @onclick="() => Reject(req)" disabled="@isBusy">
                <i class="bi bi-x-lg"></i> Reject
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>

@code {
  private bool isLoading = true;
  private bool isBusy = false;
  private string? errorMessage;
  private string? successMessage;

  private List<CounterRequest> requests = new();

  protected override async Task OnInitializedAsync()
  {
    await LoadAsync();
  }

  private async Task Reload()
  {
    if (isBusy) return;
    await LoadAsync();
  }

  private async Task LoadAsync()
  {
    isLoading = true;
    errorMessage = null;
    successMessage = null;

    try
    {
      requests = (await CounterRequestRepository.ListAsync("pending")).ToList();
    }
    catch (Exception ex)
    {
      errorMessage = $"Failed to load requests: {ex.Message}";
      requests = new List<CounterRequest>();
    }
    finally
    {
      isLoading = false;
    }
  }

  private async Task Approve(CounterRequest req)
  {
    if (isBusy) return;

    isBusy = true;
    errorMessage = null;
    successMessage = null;

    try
    {
      // Add to global counter library
      var counterId = await GenerateUniqueCounterId(req.Name);
      var libraryItem = new CounterLibraryItem
      {
        CounterId = counterId,
        Name = req.Name,
        Icon = req.Icon,
        IncrementBy = 1,
        DecrementBy = 1,
        Milestones = Array.Empty<int>(),
        CreatedAt = DateTimeOffset.UtcNow,
        LastUpdated = DateTimeOffset.UtcNow
      };

      await CounterLibraryRepository.UpsertAsync(libraryItem);
      await CounterRequestRepository.UpdateStatusAsync(req.RequestId, "approved", adminNotes: "Approved and added to counter library.");

      requests.Remove(req);
      successMessage = $"Approved: {req.Name} (key: {counterId})";
    }
    catch (Exception ex)
    {
      errorMessage = $"Failed to approve request: {ex.Message}";
    }
    finally
    {
      isBusy = false;
    }
  }

  private async Task Reject(CounterRequest req)
  {
    if (isBusy) return;

    isBusy = true;
    errorMessage = null;
    successMessage = null;

    try
    {
      await CounterRequestRepository.UpdateStatusAsync(req.RequestId, "rejected", adminNotes: "Rejected.");
      requests.Remove(req);
      successMessage = $"Rejected: {req.Name}";
    }
    catch (Exception ex)
    {
      errorMessage = $"Failed to reject request: {ex.Message}";
    }
    finally
    {
      isBusy = false;
    }
  }

  private async Task<string> GenerateUniqueCounterId(string name)
  {
    var baseId = SlugToWordKey(name);
    if (string.IsNullOrWhiteSpace(baseId))
    {
      baseId = "counter";
    }

    var existing = (await CounterLibraryRepository.ListAsync())
    .Select(c => c.CounterId)
    .ToHashSet(StringComparer.OrdinalIgnoreCase);

    var candidate = baseId;
    var i = 2;
    while (existing.Contains(candidate))
    {
      candidate = $"{baseId}_{i}";
      i++;
    }

    return candidate;
  }

  private static string SlugToWordKey(string input)
  {
    if (string.IsNullOrWhiteSpace(input)) return string.Empty;

    var chars = input.Trim().ToLowerInvariant().ToCharArray();
    var result = new System.Text.StringBuilder();
    bool lastWasUnderscore = false;

    foreach (var c in chars)
    {
      var isAlphaNum = (c >= 'a' && c <= 'z') || (c >= '0' && c <= '9');
      if (isAlphaNum)
      {
        result.Append(c);
        lastWasUnderscore = false;
        continue;
      }

      if (!lastWasUnderscore)
      {
        result.Append('_');
        lastWasUnderscore = true;
      }
    }

    var s = result.ToString().Trim('_');
    if (string.IsNullOrWhiteSpace(s)) return string.Empty;

    // Regex in chat variables uses \w+, so underscore/letters/numbers are safe.
    return s;
  }
}
