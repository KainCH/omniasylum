@page "/admin/counter-library"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Authorization
@using OmniForge.Core.Entities
@using OmniForge.Core.Interfaces
@attribute [Authorize(Roles = "admin")]
@rendermode InteractiveServer
@inject ICounterLibraryRepository CounterLibraryRepository

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Counter Library</h1>
    <button class="btn btn-outline-secondary" @onclick="Reload" disabled="@isBusy">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>

  @if (!string.IsNullOrWhiteSpace(successMessage))
  {
    <div class="alert alert-success alert-dismissible fade show">
      <i class="bi bi-check-circle me-2"></i>@successMessage
      <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
    </div>
  }

  @if (!string.IsNullOrWhiteSpace(errorMessage))
  {
    <div class="alert alert-danger alert-dismissible fade show">
      <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
      <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
  }

  @if (isLoading)
  {
    <div class="text-center p-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }
  else if (items.Count == 0)
  {
    <div class="text-center text-muted p-5">
      <i class="bi bi-collection fs-1 d-block mb-2"></i>
      No counters in the library.
    </div>
  }
  else
  {
    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
      @foreach (var item in items.OrderBy(i => i.Name))
      {
        <div class="col">
          <button type="button" class="card h-100 w-100 text-start" style="cursor:pointer;" @onclick="() => OpenEdit(item)"
            disabled="@isBusy">
            <div class="card-body">
              <div class="d-flex align-items-start justify-content-between">
                <div class="d-flex align-items-center gap-2">
                  <i class="bi @(string.IsNullOrWhiteSpace(item.Icon) ? "bi-hash" : item.Icon) fs-4"></i>
                  <div>
                    <div class="fw-semibold">@item.Name</div>
                    <div class="small text-muted">@item.CounterId</div>
                  </div>
                </div>
                <i class="bi bi-gear"></i>
              </div>

              <div class="mt-3">
                <div class="small text-muted">Commands</div>
                <div class="small">
                  <span class="me-2"><span class="text-muted">Long:</span> @GetCommandSummary(item.LongCommand,
                                    item.CounterId)</span>
              <span><span class="text-muted">Alias:</span> @GetCommandSummary(item.AliasCommand, string.Empty)</span>
            </div>
          </div>

              <div class="mt-2 d-flex flex-wrap gap-2">
                <span class="badge bg-secondary">Inc: @Math.Clamp(item.IncrementBy, 1, 10)</span>
                <span class="badge bg-secondary">Dec: @Math.Clamp(item.DecrementBy, 1, 10)</span>
                <span class="badge bg-secondary">Milestones: @GetMilestonesCount(item)</span>
              </div>
            </div>
            <div class="card-footer small text-muted">
              Click to edit
            </div>
          </button>
        </div>
        }
    </div>

    <div class="small text-muted mt-3">
      Tip: Commands are optional. If blank, the system uses <code>!{counterId}</code> and no alias.
    </div>
  }
</div>

@if (showEditModal)
{
  <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-gear me-2"></i>Edit Counter
          </h5>
          <button type="button" class="btn-close" @onclick="CloseEdit" disabled="@isBusy"></button>
        </div>
        <div class="modal-body">
          @if (editItem != null)
          {
            <div class="row g-2">
              <div class="col-12 col-md-4">
                <label class="form-label mb-1">Key</label>
                <input class="form-control" value="@editItem.CounterId" disabled />
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label mb-1">Name</label>
                <input class="form-control" @bind="editItem.Name" maxlength="60" />
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label mb-1">Icon</label>
                <input class="form-control" @bind="editItem.Icon" maxlength="60" placeholder="bi-star" />
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label mb-1">Long Command</label>
                <input class="form-control" @bind="editItem.LongCommand" maxlength="32" placeholder="!deaths" />
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label mb-1">Alias</label>
                <input class="form-control" @bind="editItem.AliasCommand" maxlength="32" placeholder="!d" />
              </div>

              <div class="col-6 col-md-3">
                <label class="form-label mb-1">Inc</label>
                <input class="form-control" type="number" @bind="editItem.IncrementBy" min="1" max="10" />
              </div>

              <div class="col-6 col-md-3">
                <label class="form-label mb-1">Dec</label>
                <input class="form-control" type="number" @bind="editItem.DecrementBy" min="1" max="10" />
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label mb-1">Milestones (comma separated)</label>
                <input class="form-control" @bind="editMilestonesCsv" placeholder="10,25,50" />
              </div>
            </div>
          }
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @onclick="CloseEdit" disabled="@isBusy">Close</button>
          <button type="button" class="btn btn-primary" @onclick="SaveEdit" disabled="@(isBusy || editItem == null)">
            @if (isBusy)
            {
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              <span>Saving...</span>
            }
            else
            {
              <i class="bi bi-save me-1"></i>

              <span>Save</span>
            }
          </button>
        </div>
      </div>
    </div>
  </div>
}

@code {
  private bool isLoading = true;
  private bool isBusy = false;
  private string? errorMessage;
  private string? successMessage;

  private List<CounterLibraryItem> items = new();

  private bool showEditModal = false;
  private CounterLibraryItem? editItem;
  private string editMilestonesCsv = string.Empty;

  protected override async Task OnInitializedAsync()
  {
    await LoadAsync();
  }

  private async Task Reload()
  {
    if (isBusy) return;
    await LoadAsync();
  }

  private async Task LoadAsync()
  {
    isLoading = true;
    errorMessage = null;
    successMessage = null;

    try
    {
      items = (await CounterLibraryRepository.ListAsync()).ToList();
      foreach (var item in items)
      {
        item.LongCommand = NormalizeCommand(item.LongCommand);
        item.AliasCommand = NormalizeCommand(item.AliasCommand);
      }
    }
    catch (Exception ex)
    {
      errorMessage = $"Failed to load counter library: {ex.Message}";
      items = new List<CounterLibraryItem>();
    }
    finally
    {
      isLoading = false;
    }
  }

  private async Task Save(CounterLibraryItem item)
  {
    if (isBusy) return;

    isBusy = true;
    errorMessage = null;
    successMessage = null;

    try
    {
      item.LongCommand = NormalizeCommand(item.LongCommand);
      item.AliasCommand = NormalizeCommand(item.AliasCommand);
      item.LastUpdated = DateTimeOffset.UtcNow;

      await CounterLibraryRepository.UpsertAsync(item);
      successMessage = $"Saved: {item.Name} ({item.CounterId})";
    }
    catch (Exception ex)
    {
      errorMessage = $"Failed to save counter: {ex.Message}";
    }
    finally
    {
      isBusy = false;
    }
  }

  private void OpenEdit(CounterLibraryItem item)
  {
    if (isBusy) return;

    errorMessage = null;
    successMessage = null;

    editItem = Clone(item);
    editMilestonesCsv = GetMilestonesCsv(editItem);
    showEditModal = true;
  }

  private void CloseEdit()
  {
    if (isBusy) return;
    showEditModal = false;
    editItem = null;
    editMilestonesCsv = string.Empty;
  }

  private async Task SaveEdit()
  {
    if (editItem == null) return;

    SetMilestonesFromCsv(editItem, editMilestonesCsv);
    await Save(editItem);

    var index = items.FindIndex(i => string.Equals(i.CounterId, editItem.CounterId, StringComparison.OrdinalIgnoreCase));
    if (index >= 0)
    {
      items[index] = Clone(editItem);
    }

    showEditModal = false;
    editItem = null;
    editMilestonesCsv = string.Empty;
  }

  private static string? NormalizeCommand(string? command)
  {
    var c = (command ?? string.Empty).Trim();
    if (string.IsNullOrWhiteSpace(c)) return string.Empty;

    if (!c.StartsWith("!", StringComparison.Ordinal))
    {
      c = "!" + c;
    }

    return c.ToLowerInvariant();
  }

  private static CounterLibraryItem Clone(CounterLibraryItem item)
  {
    return new CounterLibraryItem
    {
      CounterId = item.CounterId,
      Name = item.Name,
      Icon = item.Icon,
      LongCommand = item.LongCommand,
      AliasCommand = item.AliasCommand,
      IncrementBy = item.IncrementBy,
      DecrementBy = item.DecrementBy,
      Milestones = item.Milestones?.ToArray() ?? Array.Empty<int>(),
      CreatedAt = item.CreatedAt,
      LastUpdated = item.LastUpdated
    };
  }

  private static string GetCommandSummary(string? command, string fallbackCounterId)
  {
    var c = (command ?? string.Empty).Trim();
    if (string.IsNullOrWhiteSpace(c))
    {
      return string.IsNullOrWhiteSpace(fallbackCounterId) ? "(none)" : $"!{fallbackCounterId}";
    }

    if (!c.StartsWith("!", StringComparison.Ordinal)) c = "!" + c;
    c = c.TrimEnd('+', '-');
    return c.ToLowerInvariant();
  }

  private static int GetMilestonesCount(CounterLibraryItem item)
  {
    return item.Milestones?.Length ?? 0;
  }

  private static string GetMilestonesCsv(CounterLibraryItem item)
  {
    if (item.Milestones == null || item.Milestones.Length == 0) return string.Empty;
    return string.Join(",", item.Milestones);
  }

  private static void SetMilestonesFromCsv(CounterLibraryItem item, string? csv)
  {
    var raw = (csv ?? string.Empty).Trim();
    if (string.IsNullOrWhiteSpace(raw))
    {
      item.Milestones = Array.Empty<int>();
      return;
    }

    var parts = raw.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
    var values = new List<int>();
    foreach (var v in parts
    .Select(part => int.TryParse(part, out var parsed) ? parsed : 0)
    .Where(v => v > 0))
    {
      values.Add(v);
    }

    item.Milestones = values.Distinct().OrderBy(v => v).ToArray();
  }
}
