@page "/settings/games"
@page "/manage/{StreamerId}/settings/games"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@inject OmniForge.Core.Interfaces.IUserRepository UserRepository
@attribute [Authorize]
@using OmniForge.Web.Components.Settings

<PageTitle>Games - OmniForge</PageTitle>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-controller text-info"></i> Games</h2>
    <a href="/portal" class="btn btn-outline-secondary">Back to Portal</a>
  </div>

  @if (isLoading)
  {
    <div class="text-center">
      <div class="spinner-border text-info" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }
  else if (!hasAccess)
  {
    <div class="alert alert-danger" role="alert">@(accessDeniedMessage ?? "Access denied.")</div>
  }
  else if (string.IsNullOrWhiteSpace(userId))
  {
    <div class="alert alert-warning" role="alert">
      Unable to determine user identity. Please re-login.
    </div>
  }
  else
  {
    <GameLibraryManager UserId="@userId" />
  }
</div>

@code {
  [Parameter]
  public string? StreamerId { get; set; }

  private bool isLoading = true;
  private string? userId;
  private bool hasAccess = true;
  private string? accessDeniedMessage;

  protected override async Task OnInitializedAsync()
  {
    try
    {
      var authState = await AuthStateProvider.GetAuthenticationStateAsync();
      var actingUserId = authState.User.FindFirst("userId")?.Value
        ?? authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value
        ?? authState.User.FindFirst("sub")?.Value;

      if (string.IsNullOrWhiteSpace(actingUserId))
      {
        hasAccess = false;
        accessDeniedMessage = "Unable to determine user identity. Please re-login.";
        return;
      }

      var targetUserId = string.IsNullOrWhiteSpace(StreamerId) ? actingUserId : StreamerId;
      if (!string.Equals(targetUserId, actingUserId, StringComparison.Ordinal))
      {
        var actingUser = await UserRepository.GetUserAsync(actingUserId);
        hasAccess = actingUser != null &&
          (string.Equals(actingUser.Role, "admin", StringComparison.OrdinalIgnoreCase) ||
           (actingUser.ManagedStreamers?.Contains(targetUserId) == true));

        if (!hasAccess)
        {
          accessDeniedMessage = "You do not have permission to manage this streamer.";
          return;
        }
      }

      userId = targetUserId;
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Error loading games user context: {ex.Message}");
    }
    finally
    {
      isLoading = false;
    }
  }
}
