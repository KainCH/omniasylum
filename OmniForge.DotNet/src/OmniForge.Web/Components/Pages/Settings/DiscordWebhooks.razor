@page "/settings/discord"
@page "/manage/{StreamerId}/settings/discord"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using OmniForge.Web.Components.Settings
@inject AuthenticationStateProvider AuthStateProvider
@inject OmniForge.Core.Interfaces.IUserRepository UserRepository
@attribute [Authorize]

<PageTitle>Discord Settings - OmniForge</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-discord text-primary"></i> Discord Integration</h2>
        <a href="/portal" class="btn btn-outline-secondary">Back to Portal</a>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!hasAccess)
    {
        <div class="alert alert-danger">@(accessDeniedMessage ?? "Access denied.")</div>
    }
    else if (string.IsNullOrWhiteSpace(userId))
    {
        <div class="alert alert-danger">User not found. Please try logging in again.</div>
    }
    else
    {
        <DiscordIntegrationSettings UserId="@userId" ShowCancel="false" CloseOnSave="false" />
    }
</div>

@code {
    [Parameter]
    public string? StreamerId { get; set; }

    private bool isLoading = true;
    private string? userId;
    private bool hasAccess = true;
    private string? accessDeniedMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var actingUserId = authState.User.FindFirst("userId")?.Value
                ?? authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value
                ?? authState.User.FindFirst("sub")?.Value;

            if (string.IsNullOrWhiteSpace(actingUserId))
            {
                hasAccess = false;
                accessDeniedMessage = "Unable to determine user identity. Please re-login.";
                return;
            }

            var targetUserId = string.IsNullOrWhiteSpace(StreamerId) ? actingUserId : StreamerId;
            if (!string.Equals(targetUserId, actingUserId, StringComparison.Ordinal))
            {
                var actingUser = await UserRepository.GetUserAsync(actingUserId);
                hasAccess = actingUser != null &&
                    (string.Equals(actingUser.Role, "admin", StringComparison.OrdinalIgnoreCase) ||
                     (actingUser.ManagedStreamers?.Contains(targetUserId) == true));

                if (!hasAccess)
                {
                    accessDeniedMessage = "You do not have permission to manage this streamer.";
                    return;
                }
            }

            userId = targetUserId;
        }
        finally
        {
            isLoading = false;
        }
    }
}
