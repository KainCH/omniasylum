@page "/settings/discord"
@page "/manage/{ManagedUserId}/settings/discord"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using OmniForge.Web.Components.Settings
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]

<PageTitle>Discord Settings - OmniForge</PageTitle>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-discord text-primary"></i> Discord Integration</h2>
    <a href="portal" class="btn btn-outline-secondary">Back to Portal</a>
  </div>

  @if (isLoading)
  {
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }
  else if (string.IsNullOrWhiteSpace(userId))
  {
    <div class="alert alert-danger">User not found. Please try logging in again.</div>
  }
  else
  {
    <DiscordIntegrationSettings UserId="@userId" ShowCancel="false" CloseOnSave="false" />
  }
</div>

@code {
  [Parameter]
  public string? ManagedUserId { get; set; }

  private bool isLoading = true;
  private string? userId;

  protected override async Task OnInitializedAsync()
  {
    try
    {
      if (!string.IsNullOrEmpty(ManagedUserId))
      {
        userId = ManagedUserId;
      }
      else
      {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userId = authState.User.FindFirst("userId")?.Value;
      }
    }
    finally
    {
      isLoading = false;
    }
  }
}
