@page "/overlay/{TwitchUserId}"
@layout OmniForge.Web.Components.Layout.OverlayLayout
@using Microsoft.AspNetCore.SignalR.Client
@using OmniForge.Core.Entities
@using OmniForge.Core.Interfaces
@using System.Text.Json
@inject NavigationManager NavigationManager
@inject ICounterRepository CounterRepository
@inject IUserRepository UserRepository
@inject IAlertRepository AlertRepository
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<link href="https://fonts.googleapis.com/css2?family=Creepster&display=swap" rel="stylesheet">

@if (user == null || counter == null)
{
    <div class="loading">Loading...</div>
}
else if (!user.Features.StreamOverlay)
{
    <div class="error">Stream overlay not enabled for this user</div>
}
else
{
    <div class="counter-overlay" style="@GetPositionStyle()">
        @if (user.OverlaySettings.Counters.Deaths)
        {
            <div class="counter-item deaths" style="@GetItemStyle()">
                <div class="counter-icon">ðŸ’€</div>
                <div class="counter-info">
                    <div class="counter-label" style="color: @user.OverlaySettings.Theme.BorderColor">DEATHS</div>
                    <div class="counter-value" style="color: @user.OverlaySettings.Theme.TextColor">@counter.Deaths</div>
                </div>
            </div>
        }

        @if (user.OverlaySettings.Counters.Swears)
        {
            <div class="counter-item swears" style="@GetItemStyle()">
                <div class="counter-icon">ðŸ¤¬</div>
                <div class="counter-info">
                    <div class="counter-label" style="color: @user.OverlaySettings.Theme.BorderColor">SWEARS</div>
                    <div class="counter-value" style="color: @user.OverlaySettings.Theme.TextColor">@counter.Swears</div>
                </div>
            </div>
        }

        @if (user.OverlaySettings.Counters.Screams)
        {
            <div class="counter-item screams" style="@GetItemStyle()">
                <div class="counter-icon">ðŸ˜±</div>
                <div class="counter-info">
                    <div class="counter-label" style="color: @user.OverlaySettings.Theme.BorderColor">SCREAMS</div>
                    <div class="counter-value" style="color: @user.OverlaySettings.Theme.TextColor">@counter.Screams</div>
                </div>
            </div>
        }
    </div>
}

<style>
    body {
        background-color: transparent !important;
        margin: 0;
        padding: 20px;
        font-family: 'Arial', sans-serif;
        overflow: hidden;
    }

    .counter-overlay {
        display: flex;
        flex-direction: column;
        gap: 15px;
        position: fixed;
    }

    .counter-item {
        padding: 15px 25px;
        border-radius: 10px;
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        gap: 15px;
        min-width: 200px;
        transition: all 0.3s ease;
    }

    .counter-item:hover {
        transform: scale(1.05);
    }

    .counter-icon {
        font-size: 2rem;
        width: 40px;
        text-align: center;
    }

    .counter-info {
        flex: 1;
    }

    .counter-label {
        font-size: 1rem;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .counter-value {
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        font-family: 'Creepster', cursive;
    }
</style>

@code {
    [Parameter]
    public string TwitchUserId { get; set; } = string.Empty;

    private HubConnection? hubConnection;
    private OmniForge.Core.Entities.Counter? counter;
    private OmniForge.Core.Entities.User? user;
    private string StreamStatus { get; set; } = "offline";
    private List<Alert> alerts = new();

    protected override async Task OnInitializedAsync()
    {
        user = await UserRepository.GetUserAsync(TwitchUserId);
        if (user != null)
        {
            counter = await CounterRepository.GetCountersAsync(TwitchUserId);
            StreamStatus = user.StreamStatus;
            alerts = (await AlertRepository.GetAlertsAsync(TwitchUserId)).ToList();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && user != null && user.Features.StreamOverlay)
        {
            await JSRuntime.InvokeVoidAsync("overlayInterop.init");

            hubConnection = new HubConnectionBuilder()
                .WithUrl(NavigationManager.ToAbsoluteUri("/overlayHub"))
                .WithAutomaticReconnect()
                .Build();

            hubConnection.On<OmniForge.Core.Entities.Counter>("counterUpdate", (updatedCounter) =>
            {
                counter = updatedCounter;
                InvokeAsync(StateHasChanged);
            });

            hubConnection.On<object>("streamStatusUpdate", (data) =>
            {
                var json = JsonSerializer.Serialize(data);
                var obj = JsonSerializer.Deserialize<JsonElement>(json);
                if (obj.TryGetProperty("streamStatus", out var statusProp))
                {
                    StreamStatus = statusProp.GetString() ?? "offline";
                    InvokeAsync(StateHasChanged);
                }
            });

            hubConnection.On<object>("newFollower", async (data) => await TriggerAlert("follow", data));
            hubConnection.On<object>("newSubscriber", async (data) => await TriggerAlert("subscription", data));
            hubConnection.On<object>("resub", async (data) => await TriggerAlert("resub", data));
            hubConnection.On<object>("giftSub", async (data) => await TriggerAlert("giftsub", data));
            hubConnection.On<object>("bitsReceived", async (data) => await TriggerAlert("bits", data));
            hubConnection.On<object>("raidReceived", async (data) => await TriggerAlert("raid", data));

            hubConnection.On<object>("customAlert", async (data) =>
            {
                var json = JsonSerializer.Serialize(data);
                var obj = JsonSerializer.Deserialize<JsonElement>(json);
                if (obj.TryGetProperty("alertType", out var typeProp) && obj.TryGetProperty("data", out var payloadProp))
                {
                    await TriggerAlert(typeProp.GetString() ?? "custom", payloadProp);
                }
            });

            await hubConnection.StartAsync();
            await hubConnection.InvokeAsync("JoinGroup", TwitchUserId);
        }
    }

    private async Task TriggerAlert(string type, object data)
    {
        var alert = alerts.FirstOrDefault(a => a.Type == type && a.IsEnabled);
        if (alert == null) return;

        var payload = new Dictionary<string, object>
        {
            ["id"] = alert.Id,
            ["type"] = alert.Type,
            ["name"] = alert.Name,
            ["visualCue"] = alert.VisualCue,
            ["sound"] = alert.Sound,
            ["soundDescription"] = alert.SoundDescription,
            ["textPrompt"] = alert.TextPrompt,
            ["duration"] = alert.Duration,
            ["backgroundColor"] = alert.BackgroundColor,
            ["textColor"] = alert.TextColor,
            ["borderColor"] = alert.BorderColor
        };

        try
        {
            if (!string.IsNullOrEmpty(alert.Effects))
            {
                var effectsObj = JsonSerializer.Deserialize<object>(alert.Effects);
                if (effectsObj != null)
                {
                    payload["effects"] = effectsObj;
                }
            }
        }
        catch {}

        var json = JsonSerializer.Serialize(data);
        var dataDict = JsonSerializer.Deserialize<Dictionary<string, object>>(json);
        if (dataDict != null)
        {
            foreach (var kvp in dataDict)
            {
                if (!payload.ContainsKey(kvp.Key))
                {
                    payload[kvp.Key] = kvp.Value;
                }
            }
        }

        await JSRuntime.InvokeVoidAsync("overlayInterop.triggerAlert", type, payload);
    }

    private string GetPositionStyle()
    {
        if (user == null) return "";

        var style = "";
        var pos = user.OverlaySettings.Position;

        style += pos.Contains("top") ? "top: 20px;" : "bottom: 20px;";
        style += pos.Contains("right") ? "right: 20px;" : "left: 20px;";
        style += StreamStatus == "live" ? "opacity: 1;" : "opacity: 0;";

        return style;
    }

    private string GetItemStyle()
    {
        if (user == null) return "";

        var theme = user.OverlaySettings.Theme;
        var style = $"background: {theme.BackgroundColor}; border: 2px solid {theme.BorderColor};";

        if (user.OverlaySettings.Animations.Enabled)
        {
            style += " transition: all 0.3s ease;";
        }

        return style;
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
