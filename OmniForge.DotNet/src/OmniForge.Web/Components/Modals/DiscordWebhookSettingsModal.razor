@using OmniForge.Core.Entities
@using OmniForge.Core.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@inject IUserRepository UserRepository
@inject IDiscordService DiscordService
@inject IJSRuntime JSRuntime

@if (Show)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-discord me-2"></i>Discord Settings</h5>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    @if (isLoading)
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <ul class="nav nav-tabs mb-3">
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "notifications" ? "active" : "")" @onclick='() => activeTab = "notifications"' style="cursor: pointer;">
                                    üì¢ Notifications
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "counters" ? "active" : "")" @onclick='() => activeTab = "counters"' style="cursor: pointer;">
                                    üéØ Counters & Milestones
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "configuration" ? "active" : "")" @onclick='() => activeTab = "configuration"' style="cursor: pointer;">
                                    ‚öôÔ∏è Configuration
                                </a>
                            </li>
                        </ul>

                        <EditForm Model="@user" OnValidSubmit="SaveSettings">
                            @if (activeTab == "notifications")
                            {
                                <div class="mb-4">
                                    <h6 class="border-bottom pb-2">üîî Basic Notification Types</h6>
                                    <p class="text-muted small">Choose which types of notifications you want to receive from your stream!</p>

                                    <div class="card mb-3">
                                        <div class="card-body d-flex align-items-center">
                                            <div class="me-3 fs-2">üîî</div>
                                            <div>
                                                <h6 class="mb-0">Discord Notifications</h6>
                                                <small class="text-muted">Automatically enabled when webhook URL is configured in Configuration tab</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card mb-3 @(user.DiscordSettings.EnableChannelNotifications ? "border-primary" : "")">
                                        <div class="card-body d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3 fs-2">üí¨</div>
                                                <div>
                                                    <h6 class="mb-0">Twitch Chat Notifications</h6>
                                                    <small class="text-muted">Announce milestones and events in your Twitch chat</small>
                                                </div>
                                            </div>
                                            <div class="form-check form-switch">
                                                <InputCheckbox class="form-check-input" @bind-Value="user.DiscordSettings.EnableChannelNotifications" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                            else if (activeTab == "counters")
                            {
                                <div class="mb-4">
                                    <h6 class="border-bottom pb-2">üéØ Milestone Notifications</h6>

                                    <div class="alert alert-warning d-flex align-items-center">
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                        <div>
                                            <strong>Milestone notifications are temporarily disabled:</strong>
                                            The template system is being updated. Milestone notifications will be re-enabled once the template system is working properly.
                                        </div>
                                    </div>

                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between align-items-center bg-white">
                                            <div class="d-flex align-items-center">
                                                <span class="me-2 fs-4">üíÄ</span>
                                                <div>
                                                    <h6 class="mb-0">Death Count Milestones</h6>
                                                    <small class="text-muted">Temporarily disabled</small>
                                                </div>
                                            </div>
                                            <div class="form-check form-switch">
                                                <InputCheckbox class="form-check-input" @bind-Value="user.DiscordSettings.EnabledNotifications.DeathMilestone" disabled />
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <label class="form-label small">Milestone Thresholds</label>
                                            <InputText class="form-control" @bind-Value="deathThresholdsString" placeholder="10,25,50,100,250,500" disabled />
                                            <div class="form-text">Comma-separated list of values</div>
                                        </div>
                                    </div>

                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between align-items-center bg-white">
                                            <div class="d-flex align-items-center">
                                                <span class="me-2 fs-4">ü§¨</span>
                                                <div>
                                                    <h6 class="mb-0">Swear Count Milestones</h6>
                                                    <small class="text-muted">Temporarily disabled</small>
                                                </div>
                                            </div>
                                            <div class="form-check form-switch">
                                                <InputCheckbox class="form-check-input" @bind-Value="user.DiscordSettings.EnabledNotifications.SwearMilestone" disabled />
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <label class="form-label small">Milestone Thresholds</label>
                                            <InputText class="form-control" @bind-Value="swearThresholdsString" placeholder="25,50,100,200,500" disabled />
                                            <div class="form-text">Comma-separated list of values</div>
                                        </div>
                                    </div>
                                </div>
                            }
                            else if (activeTab == "configuration")
                            {
                                <div class="mb-4">
                                    <h6 class="border-bottom pb-2">üîß Webhook Setup</h6>
                                    <p class="text-muted small">Connect your Discord server to receive stream notifications!</p>

                                    @if (!string.IsNullOrEmpty(user.DiscordWebhookUrl))
                                    {
                                        <div class="alert alert-success py-2 px-3 mb-3 small">
                                            <i class="bi bi-check-circle-fill me-2"></i>
                                            Existing webhook configuration detected
                                        </div>
                                    }

                                    <div class="card bg-light mb-3">
                                        <div class="card-body py-2">
                                            <small>
                                                <strong>Setup Instructions:</strong>
                                                <ol class="mb-0 ps-3">
                                                    <li>Go to your Discord server settings</li>
                                                    <li>Click "Integrations" ‚Üí "Webhooks"</li>
                                                    <li>Click "New Webhook" or select an existing one</li>
                                                    <li>Copy the webhook URL and paste it below</li>
                                                </ol>
                                            </small>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            Discord Webhook URL
                                            @if (user.Features.DiscordWebhook)
                                            {
                                                <span class="text-success ms-2">(‚úÖ Enabled)</span>
                                            }
                                            else
                                            {
                                                <span class="text-danger ms-2">(‚ùå Disabled)</span>
                                            }
                                        </label>
                                        <InputText class="form-control font-monospace" @bind-Value="user.DiscordWebhookUrl" placeholder="https://discord.com/api/webhooks/..." />
                                    </div>

                                    <div class="d-flex gap-2 mb-4">
                                        <button type="button" class="btn btn-secondary" @onclick="TestWebhook" disabled="@(string.IsNullOrEmpty(user.DiscordWebhookUrl) || isTesting)">
                                            @if (isTesting)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                                <span>Sending...</span>
                                            }
                                            else
                                            {
                                                <span>üß™ Send Test</span>
                                            }
                                        </button>
                                    </div>

                                    <h6 class="border-bottom pb-2 mt-4">üéÆ Discord Server Invite</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Discord Server Invite URL</label>
                                        <InputText class="form-control font-monospace" @bind-Value="user.DiscordInviteLink" placeholder="https://discord.gg/YOUR_INVITE_CODE" />
                                    </div>

                                    @if (!string.IsNullOrEmpty(user.DiscordInviteLink))
                                    {
                                        <div class="alert alert-success bg-opacity-10 border-success text-success">
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="fs-5 me-2">üéâ</span>
                                                <strong>Invite Link Active!</strong>
                                            </div>
                                            <p class="mb-1 small">
                                                Viewers can use <code class="bg-dark text-light px-1 rounded">!discord</code> in chat to get your server invite.
                                            </p>
                                            <p class="mb-0 small opacity-75 font-monospace">
                                                Current invite: @user.DiscordInviteLink
                                            </p>
                                        </div>
                                    }
                                </div>
                            }

                            <div class="modal-footer border-top-0 px-0">
                                <button type="button" class="btn btn-secondary" @onclick="Close">Cancel</button>
                                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Save Changes</span>
                                    }
                                    else
                                    {
                                        <span>üíæ Save Changes</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public EventCallback<bool> ShowChanged { get; set; }
    [Parameter] public string UserId { get; set; } = "";

    private User user = new User();
    private bool isLoading = false;
    private bool isSaving = false;
    private bool isTesting = false;
    private string activeTab = "notifications";

    // Helper properties for comma-separated lists
    private string deathThresholdsString
    {
        get => string.Join(",", user.DiscordSettings.MilestoneThresholds.Deaths);
        set => user.DiscordSettings.MilestoneThresholds.Deaths = ParseIntList(value);
    }

    private string swearThresholdsString
    {
        get => string.Join(",", user.DiscordSettings.MilestoneThresholds.Swears);
        set => user.DiscordSettings.MilestoneThresholds.Swears = ParseIntList(value);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Show && !string.IsNullOrEmpty(UserId) && !isLoading)
        {
            await LoadSettings();
        }
    }

    private async Task LoadSettings()
    {
        isLoading = true;
        try
        {
            var loadedUser = await UserRepository.GetUserAsync(UserId);
            if (loadedUser != null)
            {
                user = loadedUser;

                // Ensure nested objects are initialized
                if (user.DiscordSettings == null) user.DiscordSettings = new DiscordSettings();
                if (user.DiscordSettings.EnabledNotifications == null) user.DiscordSettings.EnabledNotifications = new DiscordEnabledNotifications();
                if (user.DiscordSettings.MilestoneThresholds == null) user.DiscordSettings.MilestoneThresholds = new DiscordMilestoneThresholds();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading discord settings: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveSettings()
    {
        isSaving = true;
        try
        {
            // Auto-enable webhook feature if URL is present
            if (!string.IsNullOrEmpty(user.DiscordWebhookUrl))
            {
                user.Features.DiscordWebhook = true;
            }
            else
            {
                user.Features.DiscordWebhook = false;
            }

            await UserRepository.SaveUserAsync(user);
            await Close();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving discord settings: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", "Failed to save settings. Please try again.");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task TestWebhook()
    {
        if (string.IsNullOrEmpty(user.DiscordWebhookUrl)) return;

        isTesting = true;
        try
        {
            await DiscordService.SendTestNotificationAsync(user);
            await JSRuntime.InvokeVoidAsync("alert", "Test notification sent successfully!");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Failed to send test notification: {ex.Message}");
        }
        finally
        {
            isTesting = false;
        }
    }

    private List<int> ParseIntList(string value)
    {
        if (string.IsNullOrWhiteSpace(value)) return new List<int>();

        return value.Split(',')
            .Select(s => s.Trim())
            .Where(s => int.TryParse(s, out _))
            .Select(int.Parse)
            .OrderBy(i => i)
            .ToList();
    }

    private async Task Close()
    {
        Show = false;
        await ShowChanged.InvokeAsync(false);
    }
}
