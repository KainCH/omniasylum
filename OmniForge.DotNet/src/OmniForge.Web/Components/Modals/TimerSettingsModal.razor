@using OmniForge.Core.Entities
@using OmniForge.Core.Interfaces
@inject IUserRepository UserRepository
@inject IOverlayNotifier OverlayNotifier

@if (Show)
{
  <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-stopwatch me-2"></i>Timer Settings</h5>
          <button type="button" class="btn-close" @onclick="Close"></button>
        </div>
        <div class="modal-body">
          @if (!string.IsNullOrEmpty(errorMessage))
          {
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
            </div>
          }
          @if (!string.IsNullOrEmpty(successMessage))
          {
            <div class="alert alert-success">
              <i class="bi bi-check-circle me-2"></i>@successMessage
            </div>
          }

          <div class="mb-3">
            <label class="form-label">Duration (minutes)</label>
            <InputNumber TValue="int" class="form-control" @bind-Value="timerMinutes" min="0" max="999" />
            <div class="form-text">Set to 0 to use elapsed timer instead of countdown.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Timer text color</label>
            <div class="d-flex gap-2 align-items-center">
              <input type="color" class="form-control form-control-color" @bind="timerTextColor" @bind:event="oninput"
                title="Choose timer color" />
              <InputText class="form-control" @bind-Value="timerTextColor" placeholder="#ffffff" />
            </div>
            <div class="form-text">Leave blank to inherit the overlay text color.</div>
          </div>

          <div class="mb-3">
            <div class="form-check form-switch">
              <InputCheckbox id="timerRunningToggle" class="form-check-input" @bind-Value="timerRunning" />
              <label class="form-check-label" for="timerRunningToggle">Start timer (force visible)</label>
            </div>
            <div class="form-text">When enabled, the overlay timer will show even while offline and start counting
              immediately.</div>

            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-success" @onclick="StartTimerNow" disabled="@isSaving">
                <i class="bi bi-play-fill me-1"></i> Start / Restart Timer
              </button>
              <button class="btn btn-outline-danger" @onclick="StopTimerNow" disabled="@isSaving">
                <i class="bi bi-stop-fill me-1"></i> Stop Timer
              </button>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Preview</label>
            <div class="p-2 border rounded bg-body-tertiary"
              style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">
              @GetPreviewText()
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" @onclick="Close" disabled="@isSaving">Cancel</button>
          <button class="btn btn-primary" @onclick="Save" disabled="@isSaving">
            @if (isSaving)
            {
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              <span>Saving...</span>
            }
            else
            {
              <span>Save</span>
            }
          </button>
        </div>
      </div>
    </div>
  </div>
}

@code {
  [Parameter] public bool Show { get; set; }
  [Parameter] public EventCallback<bool> ShowChanged { get; set; }
  [Parameter] public string UserId { get; set; } = "";
  [Parameter] public EventCallback OnSaved { get; set; }

  private int timerMinutes = 0;
  private string? timerTextColor;
  private bool timerRunning = false;
  private bool isSaving = false;
  private string? errorMessage;
  private string? successMessage;

  protected override async Task OnParametersSetAsync()
  {
    if (!Show) return;

    errorMessage = null;
    successMessage = null;

    if (string.IsNullOrWhiteSpace(UserId))
    {
      errorMessage = "No user selected.";
      return;
    }

    try
    {
      var user = await UserRepository.GetUserAsync(UserId);
      timerMinutes = user?.OverlaySettings?.TimerDurationMinutes ?? 0;
      timerTextColor = user?.OverlaySettings?.TimerTextColor;
      timerRunning = user?.OverlaySettings?.TimerManualRunning ?? false;
    }
    catch (Exception ex)
    {
      errorMessage = $"Error loading timer settings: {ex.Message}";
    }
  }

  private string GetPreviewText()
  {
    var totalSeconds = Math.Max(0, timerMinutes) * 60;
    var minutes = totalSeconds / 60;
    var seconds = totalSeconds % 60;
    return $"{minutes:D2}:{seconds:D2}";
  }

  private async Task Save()
  {
    errorMessage = null;
    successMessage = null;

    if (string.IsNullOrWhiteSpace(UserId))
    {
      errorMessage = "No user selected.";
      return;
    }

    if (timerMinutes < 0) timerMinutes = 0;

    isSaving = true;
    try
    {
      var user = await UserRepository.GetUserAsync(UserId);
      if (user == null)
      {
        errorMessage = "User not found.";
        return;
      }

      user.OverlaySettings ??= new OverlaySettings();
      user.OverlaySettings.TimerDurationMinutes = timerMinutes;
      user.OverlaySettings.TimerTextColor = string.IsNullOrWhiteSpace(timerTextColor) ? null : timerTextColor;

      // Manual start/stop also forces timer to be enabled so it's visible on the overlay.
      user.OverlaySettings.TimerManualRunning = timerRunning;
      if (timerRunning)
      {
        user.OverlaySettings.TimerEnabled = true;
        if (!user.OverlaySettings.TimerManualStartUtc.HasValue)
        {
          user.OverlaySettings.TimerManualStartUtc = DateTimeOffset.UtcNow;
        }
      }
      else
      {
        user.OverlaySettings.TimerManualStartUtc = null;
      }

      await UserRepository.SaveUserAsync(user);
      await OverlayNotifier.NotifySettingsUpdateAsync(UserId, user.OverlaySettings);

      successMessage = "Timer settings saved.";
      await OnSaved.InvokeAsync();

      await Task.Delay(400);
      await Close();
    }
    catch (Exception ex)
    {
      errorMessage = $"Error saving timer settings: {ex.Message}";
    }
    finally
    {
      isSaving = false;
    }
  }

  private async Task StartTimerNow()
  {
    errorMessage = null;
    successMessage = null;

    if (string.IsNullOrWhiteSpace(UserId))
    {
      errorMessage = "No user selected.";
      return;
    }

    if (timerMinutes < 0) timerMinutes = 0;

    isSaving = true;
    try
    {
      var user = await UserRepository.GetUserAsync(UserId);
      if (user == null)
      {
        errorMessage = "User not found.";
        return;
      }

      user.OverlaySettings ??= new OverlaySettings();
      user.OverlaySettings.TimerDurationMinutes = timerMinutes;
      user.OverlaySettings.TimerTextColor = string.IsNullOrWhiteSpace(timerTextColor) ? null : timerTextColor;

      // Force the timer visible and restart from now
      timerRunning = true;
      user.OverlaySettings.TimerEnabled = true;
      user.OverlaySettings.TimerManualRunning = true;
      user.OverlaySettings.TimerManualStartUtc = DateTimeOffset.UtcNow;

      await UserRepository.SaveUserAsync(user);
      await OverlayNotifier.NotifySettingsUpdateAsync(UserId, user.OverlaySettings);

      successMessage = "Timer started.";
      await OnSaved.InvokeAsync();
    }
    catch (Exception ex)
    {
      errorMessage = $"Error starting timer: {ex.Message}";
    }
    finally
    {
      isSaving = false;
    }
  }

  private async Task StopTimerNow()
  {
    errorMessage = null;
    successMessage = null;

    if (string.IsNullOrWhiteSpace(UserId))
    {
      errorMessage = "No user selected.";
      return;
    }

    isSaving = true;
    try
    {
      var user = await UserRepository.GetUserAsync(UserId);
      if (user == null)
      {
        errorMessage = "User not found.";
        return;
      }

      user.OverlaySettings ??= new OverlaySettings();

      timerRunning = false;
      user.OverlaySettings.TimerManualRunning = false;
      user.OverlaySettings.TimerManualStartUtc = null;

      await UserRepository.SaveUserAsync(user);
      await OverlayNotifier.NotifySettingsUpdateAsync(UserId, user.OverlaySettings);

      successMessage = "Timer stopped.";
      await OnSaved.InvokeAsync();
    }
    catch (Exception ex)
    {
      errorMessage = $"Error stopping timer: {ex.Message}";
    }
    finally
    {
      isSaving = false;
    }
  }

  private async Task Close()
  {
    Show = false;
    await ShowChanged.InvokeAsync(false);
  }
}
