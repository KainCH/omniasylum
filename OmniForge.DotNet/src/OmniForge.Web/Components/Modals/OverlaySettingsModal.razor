@using OmniForge.Core.Entities
@using OmniForge.Core.Interfaces
@inject IUserRepository UserRepository
@inject IGameContextRepository GameContextRepository
@inject IGameCoreCountersConfigRepository GameCoreCountersConfigRepository
@inject IOverlayNotifier OverlayNotifier
@inject IJSRuntime JSRuntime

@if (Show)
{
  <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-layout-text-window-reverse me-2"></i>Overlay Settings</h5>
          <button type="button" class="btn-close" @onclick="Close"></button>
        </div>
        <div class="modal-body">
          @if (!string.IsNullOrEmpty(errorMessage))
          {
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
            </div>
          }
          @if (!string.IsNullOrEmpty(successMessage))
          {
            <div class="alert alert-success">
              <i class="bi bi-check-circle me-2"></i>@successMessage
            </div>
          }
          @if (isLoading)
          {
            <div class="text-center p-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          }
          else
          {
            <EditForm Model="@settings" OnValidSubmit="SaveSettings">
              <DataAnnotationsValidator />

              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-uppercase text-muted mb-3">General</h6>

                  <div class="form-check form-switch mb-3">
                    <InputCheckbox id="overlayEnabled" class="form-check-input" @bind-Value="settings.Enabled" />
                    <label class="form-check-label" for="overlayEnabled">Enable Overlay</label>
                  </div>

                  <div class="form-check form-switch mb-3">
                    <InputCheckbox id="offlinePreview" class="form-check-input" @bind-Value="settings.OfflinePreview" />
                    <label class="form-check-label" for="offlinePreview">Offline Preview (force visible when
                      offline)</label>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Position</label>
                    <InputSelect class="form-select" @bind-Value="settings.Position">
                      <option value="top-left">Top Left</option>
                      <option value="top-right">Top Right</option>
                      <option value="bottom-left">Bottom Left</option>
                      <option value="bottom-right">Bottom Right</option>
                      <option value="custom">Custom</option>
                    </InputSelect>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Scale (@settings.Scale.ToString("0.0")x)</label>
                    <input type="range" class="form-range" min="0.5" max="3.0" step="0.1" @bind="settings.Scale"
                      @bind:event="oninput" />
                  </div>
                </div>

                <div class="col-md-6">
                  <h6 class="text-uppercase text-muted mb-3">Visible Counters</h6>

                  <div class="form-check mb-2">
                    <InputCheckbox id="showDeaths" class="form-check-input" @bind-Value="coreDeathsEnabled" />
                    <label class="form-check-label" for="showDeaths">Deaths</label>
                  </div>

                  <div class="form-check mb-2">
                    <InputCheckbox id="showSwears" class="form-check-input" @bind-Value="coreSwearsEnabled" />
                    <label class="form-check-label" for="showSwears">Swears</label>
                  </div>

                  <div class="form-check mb-2">
                    <InputCheckbox id="showScreams" class="form-check-input" @bind-Value="coreScreamsEnabled" />
                    <label class="form-check-label" for="showScreams">Screams</label>
                  </div>

                  <div class="form-check mb-2">
                    <InputCheckbox id="showBits" class="form-check-input" @bind-Value="coreBitsEnabled" />
                    <label class="form-check-label" for="showBits">Bits</label>
                  </div>
                </div>
              </div>

              <hr />

              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-uppercase text-muted mb-3">Bits Goal</h6>

                  <div class="mb-3">
                    <label class="form-label">Target Amount</label>
                    <InputNumber class="form-control" @bind-Value="settings.BitsGoal.Target" />
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Current Amount</label>
                    <InputNumber class="form-control" @bind-Value="settings.BitsGoal.Current" />
                  </div>
                </div>

                <div class="col-md-6">
                  <h6 class="text-uppercase text-muted mb-3">Animations</h6>

                  <div class="form-check form-switch mb-2">
                    <InputCheckbox id="animEnabled" class="form-check-input" @bind-Value="settings.Animations.Enabled" />
                    <label class="form-check-label" for="animEnabled">Enable Animations</label>
                  </div>

                  <div class="form-check form-switch mb-2">
                    <InputCheckbox id="animAlerts" class="form-check-input" @bind-Value="settings.Animations.ShowAlerts" />
                    <label class="form-check-label" for="animAlerts">Show Alerts</label>
                  </div>

                  <div class="form-check form-switch mb-2">
                    <InputCheckbox id="animCeleb" class="form-check-input"
                      @bind-Value="settings.Animations.CelebrationEffects" />
                    <label class="form-check-label" for="animCeleb">Celebration Effects</label>
                  </div>
                </div>
              </div>

              <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" @onclick="Close">Cancel</button>
                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                  @if (isSaving)
                  {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Saving...</span>
                  }
                  else
                  {
                    <span>Save Changes</span>
                  }
                </button>
              </div>
            </EditForm>
          }
        </div>
      </div>
    </div>
  </div>
}

@code {
  [Parameter] public bool Show { get; set; }
  [Parameter] public EventCallback<bool> ShowChanged { get; set; }
  [Parameter] public string UserId { get; set; } = "";
  [Parameter] public EventCallback OnSaved { get; set; }

  private OverlaySettings settings = new();
  private string? activeGameId;

  // Game-scoped core counter visibility (source of truth: GameCoreCountersConfig for active game)
  private bool coreDeathsEnabled = true;
  private bool coreSwearsEnabled = true;
  private bool coreScreamsEnabled = true;
  private bool coreBitsEnabled = false;

  private bool isLoading = false;
  private bool isSaving = false;
  private string? errorMessage = null;
  private string? successMessage = null;

  protected override async Task OnParametersSetAsync()
  {
    if (Show && !string.IsNullOrEmpty(UserId) && !isLoading)
    {
      await LoadSettings();
    }
  }

  private async Task LoadSettings()
  {
    isLoading = true;
    errorMessage = null;
    try
    {
      var user = await UserRepository.GetUserAsync(UserId);
      if (user != null)
      {
        settings = user.OverlaySettings ?? new OverlaySettings();

        // Pull visible core counters from the active game's selection (if any)
        var ctx = await GameContextRepository.GetAsync(UserId);
        activeGameId = ctx?.ActiveGameId;

        if (!string.IsNullOrWhiteSpace(activeGameId))
        {
          var selection = await GameCoreCountersConfigRepository.GetAsync(UserId, activeGameId);
          if (selection == null)
          {
            // Seed selection from current user overlay settings if missing
            settings.Counters ??= new OverlayCounters();
            selection = new GameCoreCountersConfig(
            UserId: UserId,
            GameId: activeGameId,
            DeathsEnabled: settings.Counters.Deaths,
            SwearsEnabled: settings.Counters.Swears,
            ScreamsEnabled: settings.Counters.Screams,
            BitsEnabled: settings.Counters.Bits,
            UpdatedAt: DateTimeOffset.UtcNow);

            await GameCoreCountersConfigRepository.SaveAsync(UserId, activeGameId, selection);
          }

          coreDeathsEnabled = selection.DeathsEnabled;
          coreSwearsEnabled = selection.SwearsEnabled;
          coreScreamsEnabled = selection.ScreamsEnabled;
          coreBitsEnabled = selection.BitsEnabled;
        }
        else
        {
          // Fallback: no active game; use user's overlay settings
          settings.Counters ??= new OverlayCounters();
          coreDeathsEnabled = settings.Counters.Deaths;
          coreSwearsEnabled = settings.Counters.Swears;
          coreScreamsEnabled = settings.Counters.Screams;
          coreBitsEnabled = settings.Counters.Bits;
        }
      }
      else
      {
        errorMessage = $"User not found: {UserId}";
      }
    }
    catch (Exception ex)
    {
      errorMessage = $"Error loading settings: {ex.Message}";
      Console.WriteLine($"Error loading overlay settings: {ex.Message}");
    }
    finally
    {
      isLoading = false;
    }
  }

  private async Task SaveSettings()
  {
    isSaving = true;
    errorMessage = null;
    successMessage = null;
    try
    {
      var user = await UserRepository.GetUserAsync(UserId);
      if (user != null)
      {
        // Persist per-game core selection when an active game exists
        if (!string.IsNullOrWhiteSpace(activeGameId))
        {
          await GameCoreCountersConfigRepository.SaveAsync(
          UserId,
          activeGameId,
          new GameCoreCountersConfig(
          UserId: UserId,
          GameId: activeGameId,
          DeathsEnabled: coreDeathsEnabled,
          SwearsEnabled: coreSwearsEnabled,
          ScreamsEnabled: coreScreamsEnabled,
          BitsEnabled: coreBitsEnabled,
          UpdatedAt: DateTimeOffset.UtcNow));
        }

        // Also keep the user's overlay settings in sync so the overlay gets immediate updates
        settings.Counters ??= new OverlayCounters();
        settings.Counters.Deaths = coreDeathsEnabled;
        settings.Counters.Swears = coreSwearsEnabled;
        settings.Counters.Screams = coreScreamsEnabled;
        settings.Counters.Bits = coreBitsEnabled;

        user.OverlaySettings = settings;
        await UserRepository.SaveUserAsync(user);

        // Notify overlay of settings update
        await OverlayNotifier.NotifySettingsUpdateAsync(UserId, settings);

        successMessage = "Settings saved successfully!";
        Console.WriteLine($"✅ Overlay settings saved for user {UserId}");
        await OnSaved.InvokeAsync();
        // Don't close immediately - let user see the success message
        await Task.Delay(1000);
        await Close();
      }
      else
      {
        errorMessage = $"User not found: {UserId}";
      }
    }
    catch (Exception ex)
    {
      errorMessage = $"Error saving settings: {ex.Message}";
      Console.WriteLine($"❌ Error saving overlay settings: {ex.Message}");
    }
    finally
    {
      isSaving = false;
    }
  }

  private async Task Close()
  {
    Show = false;
    await ShowChanged.InvokeAsync(false);
  }
}
