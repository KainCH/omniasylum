@using OmniForge.Core.Entities
@using OmniForge.Core.Interfaces
@inject IUserRepository UserRepository
@inject IGameContextRepository GameContextRepository
@inject IGameCoreCountersConfigRepository GameCoreCountersConfigRepository
@inject IOverlayNotifier OverlayNotifier
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IDisposable

@if (Show)
{
  <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-layout-text-window-reverse me-2"></i>Overlay Settings</h5>
          <button type="button" class="btn-close" @onclick="Close"></button>
        </div>
        <div class="modal-body">
          @if (showContextSelector)
          {
            <div class="alert alert-secondary d-flex align-items-center justify-content-between mb-3">
              <div class="d-flex align-items-center">
                <i class="bi bi-person-workspace me-2"></i>
                <span>Viewing settings for:</span>
                <InputSelect TValue="string" id="contextUserSelect" class="form-select form-select-sm ms-2"
                  style="width: auto;" Value="selectedUserId" ValueChanged="OnContextChanged"
                  ValueExpression="(() => selectedUserId)">
                  <option value="@currentUserId">Myself (@currentUserDisplayName)</option>
                  @foreach (var streamer in managedStreamers)
                  {
                    <option value="@streamer.TwitchUserId">@streamer.DisplayName</option>
                  }
                </InputSelect>
              </div>
              @if (!string.IsNullOrEmpty(currentUserId) && selectedUserId != currentUserId)
              {
                <span class="badge bg-warning text-dark">
                  <i class="bi bi-eye me-1"></i>Mod view
                </span>
              }
            </div>
          }

          @if (!string.IsNullOrEmpty(errorMessage))
          {
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
            </div>
          }
          @if (!string.IsNullOrEmpty(successMessage))
          {
            <div class="alert alert-success">
              <i class="bi bi-check-circle me-2"></i>@successMessage
            </div>
          }
          @if (isLoading)
          {
            <div class="text-center p-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          }
          else
          {
            <EditForm Model="@settings" OnValidSubmit="SaveSettings">
              <DataAnnotationsValidator />

              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-uppercase text-muted mb-3">General</h6>

                  <div class="form-check form-switch mb-3">
                    <InputCheckbox id="overlayEnabled" class="form-check-input" @bind-Value="settings.Enabled" />
                    <label class="form-check-label" for="overlayEnabled">Enable Overlay</label>
                  </div>

                  <div class="form-check form-switch mb-3">
                    <InputCheckbox id="offlinePreview" class="form-check-input" @bind-Value="settings.OfflinePreview" />
                    <label class="form-check-label" for="offlinePreview">Offline Preview (force visible when
                      offline)</label>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Position</label>
                    <InputSelect class="form-select" @bind-Value="settings.Position">
                      <option value="top-left">Top Left</option>
                      <option value="top-right">Top Right</option>
                      <option value="bottom-left">Bottom Left</option>
                      <option value="bottom-right">Bottom Right</option>
                      <option value="custom">Custom</option>
                    </InputSelect>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Scale (@settings.Scale.ToString("0.0")x)</label>
                    <input type="range" class="form-range" min="0.5" max="3.0" step="0.1" @bind="settings.Scale"
                      @bind:event="oninput" />
                  </div>
                </div>

                <div class="col-md-6">
                  <h6 class="text-uppercase text-muted mb-3">Visible Counters</h6>

                  <div class="text-muted small mb-2">
                    Showing active per-game counters (read-only)
                  </div>

                  <div class="form-check mb-2">
                    <input id="showDeaths" type="checkbox" class="form-check-input" checked="@coreDeathsEnabled" disabled />
                    <label class="form-check-label" for="showDeaths">Deaths</label>
                  </div>

                  <div class="form-check mb-2">
                    <input id="showSwears" type="checkbox" class="form-check-input" checked="@coreSwearsEnabled" disabled />
                    <label class="form-check-label" for="showSwears">Swears</label>
                  </div>

                  <div class="form-check mb-2">
                    <input id="showScreams" type="checkbox" class="form-check-input" checked="@coreScreamsEnabled"
                      disabled />
                    <label class="form-check-label" for="showScreams">Screams</label>
                  </div>

                  <div class="form-check mb-2">
                    <input id="showBits" type="checkbox" class="form-check-input" checked="@coreBitsEnabled" disabled />
                    <label class="form-check-label" for="showBits">Bits</label>
                  </div>
                </div>
              </div>

              <hr />

              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-uppercase text-muted mb-3">Bits Goal</h6>

                  <div class="mb-3">
                    <label class="form-label">Target Amount</label>
                    <InputNumber class="form-control" @bind-Value="settings.BitsGoal.Target" />
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Current Amount</label>
                    <InputNumber class="form-control" @bind-Value="settings.BitsGoal.Current" />
                  </div>
                </div>

                <div class="col-md-6">
                  <h6 class="text-uppercase text-muted mb-3">Animations</h6>

                  <div class="form-check form-switch mb-2">
                    <InputCheckbox id="animEnabled" class="form-check-input" @bind-Value="settings.Animations.Enabled" />
                    <label class="form-check-label" for="animEnabled">Enable Animations</label>
                  </div>

                  <div class="form-check form-switch mb-2">
                    <InputCheckbox id="animAlerts" class="form-check-input" @bind-Value="settings.Animations.ShowAlerts" />
                    <label class="form-check-label" for="animAlerts">Show Alerts</label>
                  </div>

                  <div class="form-check form-switch mb-2">
                    <InputCheckbox id="animCeleb" class="form-check-input"
                      @bind-Value="settings.Animations.CelebrationEffects" />
                    <label class="form-check-label" for="animCeleb">Celebration Effects</label>
                  </div>
                </div>
              </div>

              <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" @onclick="Close">Cancel</button>
                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                  @if (isSaving)
                  {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Saving...</span>
                  }
                  else
                  {
                    <span>Save Changes</span>
                  }
                </button>
              </div>
            </EditForm>
          }
        </div>
      </div>
    </div>
  </div>
}

@code {
  [Parameter] public bool Show { get; set; }
  [Parameter] public EventCallback<bool> ShowChanged { get; set; }
  [Parameter] public string UserId { get; set; } = "";
  [Parameter] public EventCallback OnSaved { get; set; }

  private OverlaySettings settings = new();
  private string? activeGameId;

  private string? currentUserId;
  private string currentUserDisplayName = "Me";
  private readonly List<User> managedStreamers = new();
  private string? selectedUserId;
  private bool showContextSelector;
  private string? contextLoadedForUserId;
  private readonly SemaphoreSlim contextLoadSemaphore = new(1, 1);

  // Game-scoped core counter visibility (source of truth: GameCoreCountersConfig for active game)
  private bool coreDeathsEnabled = true;
  private bool coreSwearsEnabled = true;
  private bool coreScreamsEnabled = true;
  private bool coreBitsEnabled = false;

  private bool isLoading = false;
  private bool isSaving = false;
  private string? errorMessage = null;
  private string? successMessage = null;
  protected override async Task OnParametersSetAsync()
  {
    if (Show && !isLoading)
    {
      await EnsureContextLoadedAsync();

      // Default selection: prefer explicit UserId param, else current user.
      // If caller updates UserId between openings, always respect it.
      if (!string.IsNullOrWhiteSpace(UserId))
      {
        if (selectedUserId != UserId)
        {
          selectedUserId = UserId;
        }
      }
      else if (string.IsNullOrWhiteSpace(selectedUserId))
      {
        selectedUserId = currentUserId;
      }

      if (!string.IsNullOrWhiteSpace(selectedUserId))
      {
        // Hard validation (prevents tampering): only allow self or managed streamers.
        if (IsAllowedContext(selectedUserId))
        {
          await LoadSettings(selectedUserId);
        }
        else
        {
          errorMessage = "You do not have permission to view that user's settings.";
        }
      }
    }
  }

  private async Task EnsureContextLoadedAsync()
  {
    await contextLoadSemaphore.WaitAsync();
    try
    {
      var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
      currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value
      ?? authState.User.FindFirst("userId")?.Value;

      if (string.IsNullOrWhiteSpace(currentUserId))
      {
        contextLoadedForUserId = null;
        managedStreamers.Clear();
        showContextSelector = false;
        return;
      }

      // Avoid repeated reloads within the same component instance.
      if (contextLoadedForUserId == currentUserId)
      {
        showContextSelector = managedStreamers.Any();
        return;
      }

      var currentUser = await UserRepository.GetUserAsync(currentUserId);
      currentUserDisplayName = currentUser?.DisplayName ?? currentUser?.Username ?? "Me";

      managedStreamers.Clear();
      if (currentUser?.ManagedStreamers != null && currentUser.ManagedStreamers.Any())
      {
        var streamerIds = currentUser.ManagedStreamers
        .Where(id => !string.IsNullOrWhiteSpace(id))
        .Distinct()
        .ToArray();

        var streamerTasks = streamerIds.Select(UserRepository.GetUserAsync);
        var streamerResults = await Task.WhenAll(streamerTasks);

        managedStreamers.AddRange(streamerResults.Where(streamer => streamer != null).Cast<User>());
      }

      showContextSelector = managedStreamers.Any();
      contextLoadedForUserId = currentUserId;
    }
    catch (Exception ex)
    {
      Console.WriteLine($"❌ Error loading context selector state: {ex.Message}");
      contextLoadedForUserId = null;
      showContextSelector = false;
    }
    finally
    {
      contextLoadSemaphore.Release();
    }
  }

  private bool IsAllowedContext(string userId)
  {
    if (string.IsNullOrWhiteSpace(userId)) return false;
    if (string.IsNullOrWhiteSpace(currentUserId)) return false;
    if (userId == currentUserId) return true;
    return managedStreamers.Any(s => s.TwitchUserId == userId);
  }

  private async Task OnContextChanged(string? newUserId)
  {
    if (string.IsNullOrWhiteSpace(newUserId)) return;

    errorMessage = null;
    successMessage = null;

    if (!IsAllowedContext(newUserId))
    {
      errorMessage = "You do not have permission to view that user's settings.";
      return;
    }

    selectedUserId = newUserId;
    await LoadSettings(selectedUserId);
  }

  private async Task LoadSettings(string targetUserId)
  {
    isLoading = true;
    errorMessage = null;
    try
    {
      var user = await UserRepository.GetUserAsync(targetUserId);
      if (user != null)
      {
        settings = user.OverlaySettings ?? new OverlaySettings();

        settings.Counters ??= new OverlayCounters();

        // Pull visible core counters from the active game's selection (if any)
        var ctx = await GameContextRepository.GetAsync(targetUserId);
        activeGameId = ctx?.ActiveGameId;

        if (!string.IsNullOrWhiteSpace(activeGameId))
        {
          var selection = await GameCoreCountersConfigRepository.GetAsync(targetUserId, activeGameId);
          if (selection != null)
          {
            coreDeathsEnabled = selection.DeathsEnabled;
            coreSwearsEnabled = selection.SwearsEnabled;
            coreScreamsEnabled = selection.ScreamsEnabled;
            coreBitsEnabled = selection.BitsEnabled;
          }
          else
          {
            // No per-game selection exists yet; show user's current overlay settings as a fallback.
            settings.Counters ??= new OverlayCounters();
            coreDeathsEnabled = settings.Counters.Deaths;
            coreSwearsEnabled = settings.Counters.Swears;
            coreScreamsEnabled = settings.Counters.Screams;
            coreBitsEnabled = settings.Counters.Bits;
          }
        }
        else
        {
          // Fallback: no active game; use user's overlay settings
          coreDeathsEnabled = settings.Counters.Deaths;
          coreSwearsEnabled = settings.Counters.Swears;
          coreScreamsEnabled = settings.Counters.Screams;
          coreBitsEnabled = settings.Counters.Bits;
        }
      }
      else
      {
        errorMessage = $"User not found: {targetUserId}";
      }
    }
    catch (Exception ex)
    {
      errorMessage = $"Error loading settings: {ex.Message}";
      Console.WriteLine($"Error loading overlay settings: {ex.Message}");
    }
    finally
    {
      isLoading = false;
    }
  }

  private async Task SaveSettings()
  {
    isSaving = true;
    errorMessage = null;
    successMessage = null;
    try
    {
      if (string.IsNullOrWhiteSpace(selectedUserId))
      {
        errorMessage = "No user selected.";
        return;
      }

      if (!IsAllowedContext(selectedUserId))
      {
        errorMessage = "You do not have permission to update that user's settings.";
        return;
      }

      var user = await UserRepository.GetUserAsync(selectedUserId);
      if (user != null)
      {
        // Do NOT write per-game core counter selection from this modal.
        // Preserve the existing stored counter selection when saving general overlay settings.
        settings.Counters = user.OverlaySettings?.Counters ?? settings.Counters ?? new OverlayCounters();

        user.OverlaySettings = settings;
        await UserRepository.SaveUserAsync(user);

        // Notify overlay of settings update
        await OverlayNotifier.NotifySettingsUpdateAsync(selectedUserId, settings);

        successMessage = "Settings saved successfully!";
        Console.WriteLine($"✅ Overlay settings saved for user {selectedUserId}");
        await OnSaved.InvokeAsync();
        // Don't close immediately - let user see the success message
        await Task.Delay(1000);
        await Close();
      }
      else
      {
        errorMessage = $"User not found: {selectedUserId}";
      }
    }
    catch (Exception ex)
    {
      errorMessage = $"Error saving settings: {ex.Message}";
      Console.WriteLine($"❌ Error saving overlay settings: {ex.Message}");
    }
    finally
    {
      isSaving = false;
    }
  }

  private async Task Close()
  {
    Show = false;
    await ShowChanged.InvokeAsync(false);
  }

  public void Dispose()
  {
    contextLoadSemaphore.Dispose();
  }
}
