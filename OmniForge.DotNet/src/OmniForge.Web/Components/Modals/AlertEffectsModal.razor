@inject IJSRuntime JSRuntime

@if (Show)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog" role="document">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-magic me-2"></i>Alert Effects</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    @if (isLoading)
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="mb-4">
                            <label class="form-label">Master Volume: @volume%</label>
                            <input type="range" class="form-range" min="0" max="100" @bind="volume" @bind:after="SaveVolume" />
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableSound" @bind="settings.EnableSound" />
                            <label class="form-check-label" for="enableSound">Enable Sound Effects</label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableAnimations" @bind="settings.EnableAnimations" />
                            <label class="form-check-label" for="enableAnimations">Enable Animations</label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableParticles" @bind="settings.EnableParticles" />
                            <label class="form-check-label" for="enableParticles">Enable Particle Effects</label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableScreenEffects" @bind="settings.EnableScreenEffects" />
                            <label class="form-check-label" for="enableScreenEffects">Enable Screen Effects (Shake/Flash)</label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableSVGFilters" @bind="settings.EnableSVGFilters" />
                            <label class="form-check-label" for="enableSVGFilters">Enable SVG Filters (Distortion)</label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableTextEffects" @bind="settings.EnableTextEffects" />
                            <label class="form-check-label" for="enableTextEffects">Enable Text Effects</label>
                        </div>
                    }
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" @onclick="Close">Close</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveSettings">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public EventCallback<bool> ShowChanged { get; set; }

    private AlertSettings settings = new();
    private int volume = 70;
    private bool isLoading = false;

    protected override async Task OnParametersSetAsync()
    {
        if (Show && !isLoading)
        {
            await LoadSettings();
        }
    }

    private async Task LoadSettings()
    {
        isLoading = true;
        try
        {
            var savedSettings = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "asylumEffectsSettings");
            if (!string.IsNullOrEmpty(savedSettings))
            {
                settings = System.Text.Json.JsonSerializer.Deserialize<AlertSettings>(savedSettings) ?? new AlertSettings();
            }

            var savedVolume = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "asylumEffectsVolume");
            if (!string.IsNullOrEmpty(savedVolume) && int.TryParse(savedVolume, out int v))
            {
                volume = v;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading alert settings: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveSettings()
    {
        try
        {
            var json = System.Text.Json.JsonSerializer.Serialize(settings);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "asylumEffectsSettings", json);
            await Close();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving alert settings: {ex.Message}");
        }
    }

    private async Task SaveVolume()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "asylumEffectsVolume", volume.ToString());
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving volume: {ex.Message}");
        }
    }

    private async Task Close()
    {
        Show = false;
        await ShowChanged.InvokeAsync(false);
    }

    public class AlertSettings
    {
        public bool EnableSound { get; set; } = true;
        public bool EnableAnimations { get; set; } = true;
        public bool EnableParticles { get; set; } = true;
        public bool EnableScreenEffects { get; set; } = true;
        public bool EnableSVGFilters { get; set; } = true;
        public bool EnableTextEffects { get; set; } = true;
    }
}
