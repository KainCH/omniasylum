{"type":"entity","name":"Azure Deployment Process","entityType":"deployment_procedure","observations":["OmniAsylum Stream Counter is deployed to Azure Container Apps in resource group 'Streamer-Tools-RG'","Uses Azure Container Registry 'omniforgeacr' to store Docker images","Container app name is 'omniforgestream-api-prod' running in South Central US region","Deployment URL: https://omniforgestream-api-prod.proudplant-8dc6fe7a.southcentralus.azurecontainerapps.io","Uses Azure Key Vault 'forge-steel-vault' for secrets management","Storage account 'omni46jismtjodyuc' for Table Storage data persistence","Application Insights 'omniforgestream-insights-prod' for monitoring","Deployment uses existing Bicep infrastructure in deploy/main.bicep","Container Apps environment manages scaling and networking automatically","Uses HTTPS with automatic certificate management","WebSocket support enabled with TCP scaling rules","Environment variables are managed through Azure Key Vault","Database mode switches automatically to 'azure' in production"]}
{"type":"entity","name":"Docker Build Process","entityType":"build_procedure","observations":["Build Docker image locally first: 'docker build -t omniforgestream-api:latest .'","Login to Azure Container Registry: 'az acr login --name omniforgeacr'","Tag image for registry: 'docker tag omniforgestream-api:latest omniforgeacr.azurecr.io/omniforgestream-api:latest'","Push to registry: 'docker push omniforgeacr.azurecr.io/omniforgestream-api:latest'","Always test Docker build locally before pushing to ensure it works properly","Build process must be run from the API directory: cd 'c:\\Game Data\\Coding Projects\\doc-omni\\API'","Dockerfile uses Node.js 20 Alpine for smaller image size","Production dependencies are installed with 'npm ci --only=production'","Image includes all JavaScript files and frontend directory","Non-root user 'node' is used for security","Data directory is created with proper permissions"]}
{"type":"entity","name":"Azure Container App Update","entityType":"deployment_procedure","observations":["Update running container app: 'az containerapp update --name omniforgestream-api-prod --resource-group Streamer-Tools-RG --image omniforgeacr.azurecr.io/omniforgestream-api:latest'","Container app auto-scales from 0-5 instances based on demand","Uses managed identity 'bears-stream-UAMI' for secure access to Azure resources","Target port 3000 matches application listening port","WebSocket scaling rules configured for real-time connections"]}
{"type":"entity","name":"Authentication Fix Process","entityType":"troubleshooting_procedure","observations":["Fixed 401 admin authentication errors by correcting requireAdmin middleware","Changed requireAdmin to not call requireAuth internally to prevent double authentication","Updated all admin routes to use both 'requireAuth, requireAdmin' middleware chain","Admin routes now properly validate JWT tokens before checking admin role","Added new admin endpoint GET /api/admin/streams for stream session monitoring","Issue was caused by requireAdmin middleware calling requireAuth internally","Double authentication created middleware conflicts and 401 errors","Solution was to make requireAdmin expect req.user to already be set","All admin routes now explicitly use both middlewares in order","JWT token validation happens first, then admin role checking","Added proper error messages to distinguish auth vs authorization failures"]}
{"type":"entity","name":"Deployment Verification Steps","entityType":"testing_procedure","observations":["Test health endpoint: 'curl https://omniforgestream-api-prod.proudplant-8dc6fe7a.southcentralus.azurecontainerapps.io/api/health'","Check container logs: 'az containerapp logs show --name omniforgestream-api-prod --resource-group Streamer-Tools-RG --tail 10'","Verify overlay endpoint works (returns HTML): '/overlay/{userId}'","Confirm WebSocket connections show in logs: 'connected: Username (ID)'","Admin panel should load without 401 errors after authentication fixes"]}
{"type":"entity","name":"Azure Resources Structure","entityType":"infrastructure","observations":["Resource Group: Streamer-Tools-RG in South Central US","Container Registry: omniforgeacr for image storage","Container App: omniforgestream-api-prod with external ingress","Key Vault: forge-steel-vault stores Twitch secrets and JWT secret","Storage Account: omni46jismtjodyuc for Table Storage (users/counters)","Log Analytics: omniforgestream-logs-prod for application logging","Application Insights: omniforgestream-insights-prod for monitoring","Managed Identity: bears-stream-UAMI for passwordless resource access"]}
{"type":"entity","name":"Stream Integration Features","entityType":"feature_set","observations":["Bits counter with stream session reset functionality","Real-time WebSocket overlay for OBS browser source integration","Subscriber celebration animations with animated overlays","Stream session management with !startstream and !endstream commands","Moderator permissions for stream control commands","Configurable bit celebration thresholds per user","Public commands: !bits, !streamstats for viewers","Admin stream monitoring endpoint showing active sessions"]}
{"type":"entity","name":"OBS Overlay Integration","entityType":"streaming_feature","observations":["Browser source URL format: https://domain/overlay/{userId}","Real-time counter updates via WebSocket connections","Animated celebration effects for bits and subscribers","Transparent background for overlay compatibility","CSS animations for counter changes and alerts","Responsive design works on all stream layouts","Supports death counter, swear counter, and bits display"]}
{"type":"entity","name":"Stream Command System","entityType":"chat_integration","observations":["Moderator commands: !startstream, !endstream, !resetbits","Counter commands for mods: !death+, !death-, !swear+, !swear-","Public viewer commands: !deaths, !swears, !bits, !stats, !streamstats","Commands work for both broadcaster and moderators","Stream session tracking with automatic bits counter reset","Integration with Twitch chat via Twurple library","Permission checking via Twitch userInfo flags (isBroadcaster, isMod)"]}
{"type":"relation","from":"Docker Build Process","to":"Azure Container App Update","relationType":"precedes"}
{"type":"relation","from":"Azure Deployment Process","to":"Azure Resources Structure","relationType":"utilizes"}
{"type":"relation","from":"Authentication Fix Process","to":"Deployment Verification Steps","relationType":"enables"}
{"type":"relation","from":"Stream Integration Features","to":"OBS Overlay Integration","relationType":"includes"}
{"type":"relation","from":"Stream Integration Features","to":"Stream Command System","relationType":"includes"}
{"type":"relation","from":"Azure Deployment Process","to":"Stream Integration Features","relationType":"deploys"}
{"type":"relation","from":"Deployment Verification Steps","to":"OBS Overlay Integration","relationType":"validates"}
{"type":"relation","from":"Stream Command System","to":"Authentication Fix Process","relationType":"requires"}