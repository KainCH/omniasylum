name: PR Validation

on:
  pull_request:
    branches: [main]
    paths:
      - 'OmniForge.DotNet/**'
      - '.github/**'
      - '.vscode/**'

permissions:
  contents: read
  pull-requests: write

env:
  DOTNET_VERSION: '9.0.x'
  SOLUTION_PATH: 'OmniForge.DotNet/OmniForge.sln'
  COVERAGE_THRESHOLD: 85

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

      - name: Run tests with coverage
        run: |
          dotnet test ${{ env.SOLUTION_PATH }} \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --settings OmniForge.DotNet/coverlet.runsettings \
            --results-directory ./coverage

      - name: Generate coverage report
        uses: danielpalme/ReportGenerator-GitHub-Action@5.3.8
        with:
          reports: 'coverage/**/coverage.cobertura.xml'
          targetdir: 'coveragereport'
          reporttypes: 'HtmlInline;Cobertura;MarkdownSummaryGithub'

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coveragereport

      - name: Add coverage to PR
        uses: marocchino/sticky-pull-request-comment@v2
        if: github.event_name == 'pull_request'
        with:
          recreate: true
          path: coveragereport/SummaryGithub.md

      - name: Check coverage threshold
        run: |
          COVERAGE_FILE=$(find coverage -name "coverage.cobertura.xml" | head -1)
          if [ -f "$COVERAGE_FILE" ]; then
            LINE_RATE=$(grep -oP 'line-rate="\K[^"]+' "$COVERAGE_FILE" | head -1)
            COVERAGE_PERCENT=$(echo "$LINE_RATE * 100" | bc)
            echo "ðŸ“Š Code Coverage: ${COVERAGE_PERCENT}%"

            if (( $(echo "$COVERAGE_PERCENT < ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
              echo "âŒ Coverage ${COVERAGE_PERCENT}% is below threshold of ${{ env.COVERAGE_THRESHOLD }}%"
              exit 1
            else
              echo "âœ… Coverage ${COVERAGE_PERCENT}% meets threshold of ${{ env.COVERAGE_THRESHOLD }}%"
            fi
          else
            echo "âš ï¸ Coverage file not found"
            exit 1
          fi

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Check code formatting
        run: dotnet format ${{ env.SOLUTION_PATH }} --verify-no-changes --verbosity diagnostic

      - name: Run analyzers
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release -warnaserror
